@model SiBMN.Models.ViewModels.DetailPengajuanCreateViewModel
@{
    ViewData["Title"] = "Tambah Barang Modal";
}

<div class="fade-in">
    <div class="mb-4">
        <a href="@Url.Action("Details", "Pengajuan", new { id = Model.IdPengajuan })" class="btn-outline-custom mb-3" style="font-size:0.8rem;">
            <i class="fas fa-arrow-left"></i> Kembali ke Detail Pengajuan
        </a>
    </div>

    <form asp-action="Create" method="post">
        <input type="hidden" asp-for="IdPengajuan" />

        <!-- Informasi Barang -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="fas fa-box"></i> Informasi Barang
            </div>

            <div class="row g-3">
                <!-- Cascading Filter for Barang -->
                <div class="col-12">
                    <label class="form-label" style="font-weight:600; color:var(--text-secondary); font-size:0.85rem;">
                        <i class="fas fa-filter me-1"></i>Filter Kode Barang (opsional)
                    </label>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filterGolongan">
                                <option value="">-- Semua Golongan --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filterBidang">
                                <option value="">-- Semua Bidang --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filterKelompok">
                                <option value="">-- Semua Kelompok --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filterSubKelompok">
                                <option value="">-- Semua Sub Kel. --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <label asp-for="IdBarang" class="form-label">
                        Nama Barang <span class="required-star">*</span>
                    </label>
                    <select asp-for="IdBarang" asp-items="@(ViewBag.Barangs as SelectList)" class="form-select" id="barangSelect">
                        <option value="">-- Cari & Pilih Barang --</option>
                    </select>
                    <span asp-validation-for="IdBarang" class="text-danger" style="font-size:0.8rem;"></span>
                    <div class="form-text" id="barangCount">Menampilkan semua barang</div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Satuan</label>
                    <input type="text" class="form-control" id="satuanDisplay" disabled placeholder="Otomatis" />
                </div>

                <div class="col-12">
                    <label asp-for="Spesifikasi" class="form-label">
                        Spesifikasi
                    </label>
                    <textarea asp-for="Spesifikasi" class="form-control" rows="3" placeholder="Deskripsi spesifikasi barang (unlimited karakter)"></textarea>
                    <div class="form-text">Tulis spesifikasi detail barang yang diminta</div>
                </div>
            </div>
        </div>

        <!-- Volume & Harga -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="fas fa-calculator"></i> Volume & Harga
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="JumlahDiminta" class="form-label">
                        Volume <span class="required-star">*</span>
                    </label>
                    <input asp-for="JumlahDiminta" class="form-control" type="number" min="1" placeholder="0" oninput="calculateTotal()" id="JumlahDiminta" />
                    <span asp-validation-for="JumlahDiminta" class="text-danger" style="font-size:0.8rem;"></span>
                    <div class="form-text">Hanya menerima input angka</div>
                </div>

                <div class="col-md-4">
                    <label asp-for="HargaSatuan" class="form-label">
                        Harga Satuan (Rp) <span class="required-star">*</span>
                    </label>
                    <input asp-for="HargaSatuan" class="form-control" type="number" min="0" step="1" placeholder="0" oninput="calculateTotal()" id="HargaSatuan" />
                    <span asp-validation-for="HargaSatuan" class="text-danger" style="font-size:0.8rem;"></span>
                    <div class="form-text">Hanya menerima input angka</div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Jumlah Harga</label>
                    <input type="text" class="form-control" id="JumlahHarga" disabled placeholder="Rp 0" style="font-weight:700; color:var(--primary);" />
                    <div class="form-text">Hasil perkalian volume × harga satuan</div>
                </div>
            </div>
        </div>

        <!-- Lokasi Penempatan -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="fas fa-map-marker-alt"></i> Lokasi Penempatan
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">
                        Filter Gedung <span class="required-star">*</span>
                    </label>
                    <select class="form-select" id="gedungSelect" onchange="filterRuangByGedung()">
                        <option value="">-- Pilih Gedung --</option>
                        @foreach (var gedung in ViewBag.Gedungs as List<string>)
                        {
                            <option value="@gedung">@gedung</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label asp-for="IdRuang" class="form-label">
                        Ruang <span class="required-star">*</span>
                    </label>
                    <select asp-for="IdRuang" class="form-select" id="IdRuang">
                        <option value="">-- Pilih Gedung Dulu --</option>
                    </select>
                    <span asp-validation-for="IdRuang" class="text-danger" style="font-size:0.8rem;"></span>
                </div>
            </div>
        </div>

        <!-- Fungsi & Asal Barang -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="fas fa-info-circle"></i> Fungsi & Asal Barang
            </div>

            <div class="row g-3">
                <div class="col-12">
                    <label asp-for="FungsiBarang" class="form-label">Fungsi Barang</label>
                    <textarea asp-for="FungsiBarang" class="form-control" rows="2" placeholder="Deskripsi fungsi / kegunaan barang"></textarea>
                </div>

                <div class="col-12">
                    <label class="form-label">
                        Asal Barang <span class="required-star">*</span>
                    </label>
                    <div class="d-flex gap-4 mt-1">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="AsalBarang" value="PDN" id="asalPDN"
                                   checked onchange="handleAsalBarang()" />
                            <label class="form-check-label" for="asalPDN">
                                <strong>PDN</strong> (Produk Dalam Negeri)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="AsalBarang" value="Import" id="asalImport"
                                   onchange="handleAsalBarang()" />
                            <label class="form-check-label" for="asalImport">
                                <strong>Import</strong>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Conditional: Import -->
                <div class="col-12 conditional-field" id="importField">
                    <label asp-for="AlasanImport" class="form-label">
                        Alasan Pemilihan Produk Import
                    </label>
                    <textarea asp-for="AlasanImport" class="form-control" rows="2" placeholder="Jelaskan alasan pemilihan produk import"></textarea>
                </div>

                <!-- Conditional: PDN (upload TKDN) -->
                <div class="col-12 conditional-field show" id="pdnField">
                    <label class="form-label">Upload Sertifikat TKDN</label>
                    <input type="file" class="form-control" accept=".pdf,.jpg,.png" />
                    <div class="form-text">Format: PDF, JPG, PNG</div>
                </div>
            </div>
        </div>

        <!-- Link & Gambar -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="fas fa-link"></i> Link Survey & Gambar
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="LinkSurvey" class="form-label">
                        Link Survey (e-katalog)
                    </label>
                    <input asp-for="LinkSurvey" class="form-control" placeholder="https://e-katalog.lkpp.go.id/..." />
                    <div class="form-text"><span class="required-star">*</span> wajib dari e-katalog</div>
                </div>

                <div class="col-md-6">
                    <label asp-for="LinkGambar" class="form-label">
                        Gambar di Link e-katalog
                    </label>
                    <input type="file" class="form-control" accept="image/*" />
                    <div class="form-text">Ukuran gambar max 2MB</div>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="d-flex gap-3">
            <button type="submit" class="btn-primary-custom">
                <i class="fas fa-save"></i> Simpan Barang
            </button>
            <a href="@Url.Action("Details", "Pengajuan", new { id = Model.IdPengajuan })" class="btn-outline-custom">
                <i class="fas fa-times"></i> Batal
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Store all barang options for client-side filtering
        var allBarangOptions = [];
        var barangSelect = document.getElementById('barangSelect');

        // Save all options on load
        document.addEventListener('DOMContentLoaded', function () {
            for (var i = 0; i < barangSelect.options.length; i++) {
                allBarangOptions.push({
                    value: barangSelect.options[i].value,
                    text: barangSelect.options[i].text
                });
            }
            updateBarangCount();

            // Load Golongan filter dropdown
            fetch('/api/KodeBarangApi/Golongan')
                .then(r => r.json())
                .then(data => {
                    var sel = document.getElementById('filterGolongan');
                    data.forEach(item => {
                        sel.add(new Option(`${item.kode} - ${item.uraian}`, item.kode));
                    });
                });

            // Cascading: Golongan → Bidang
            document.getElementById('filterGolongan').addEventListener('change', function () {
                var val = this.value;
                var bidangSel = document.getElementById('filterBidang');
                var kelompokSel = document.getElementById('filterKelompok');
                var subkelSel = document.getElementById('filterSubKelompok');
                bidangSel.innerHTML = '<option value="">-- Semua Bidang --</option>';
                kelompokSel.innerHTML = '<option value="">-- Semua Kelompok --</option>';
                subkelSel.innerHTML = '<option value="">-- Semua Sub Kel. --</option>';
                filterBarangDropdown();
                if (!val) return;
                fetch(`/api/KodeBarangApi/Bidang?kodeGolongan=${val}`)
                    .then(r => r.json())
                    .then(data => {
                        data.forEach(item => { bidangSel.add(new Option(`${item.kode} - ${item.uraian}`, item.kode)); });
                    });
            });

            // Cascading: Bidang → Kelompok
            document.getElementById('filterBidang').addEventListener('change', function () {
                var golVal = document.getElementById('filterGolongan').value;
                var val = this.value;
                var kelompokSel = document.getElementById('filterKelompok');
                var subkelSel = document.getElementById('filterSubKelompok');
                kelompokSel.innerHTML = '<option value="">-- Semua Kelompok --</option>';
                subkelSel.innerHTML = '<option value="">-- Semua Sub Kel. --</option>';
                filterBarangDropdown();
                if (!golVal || !val) return;
                fetch(`/api/KodeBarangApi/Kelompok?kodeGolongan=${golVal}&kodeBidang=${val}`)
                    .then(r => r.json())
                    .then(data => {
                        data.forEach(item => { kelompokSel.add(new Option(`${item.kode} - ${item.uraian}`, item.kode)); });
                    });
            });

            // Cascading: Kelompok → Sub Kelompok
            document.getElementById('filterKelompok').addEventListener('change', function () {
                var golVal = document.getElementById('filterGolongan').value;
                var bidangVal = document.getElementById('filterBidang').value;
                var val = this.value;
                var subkelSel = document.getElementById('filterSubKelompok');
                subkelSel.innerHTML = '<option value="">-- Semua Sub Kel. --</option>';
                filterBarangDropdown();
                if (!golVal || !bidangVal || !val) return;
                fetch(`/api/KodeBarangApi/SubKelompok?kodeGolongan=${golVal}&kodeBidang=${bidangVal}&kodeKelompok=${val}`)
                    .then(r => r.json())
                    .then(data => {
                        data.forEach(item => { subkelSel.add(new Option(`${item.kode} - ${item.uraian}`, item.kode)); });
                    });
            });

            // Sub Kelompok change → filter
            document.getElementById('filterSubKelompok').addEventListener('change', function () {
                filterBarangDropdown();
            });
        });

        function filterBarangDropdown() {
            var golVal = document.getElementById('filterGolongan').value;
            var bidangVal = document.getElementById('filterBidang').value;
            var kelompokVal = document.getElementById('filterKelompok').value;
            var subkelVal = document.getElementById('filterSubKelompok').value;

            barangSelect.innerHTML = '<option value="">-- Cari & Pilih Barang --</option>';
            var count = 0;

            allBarangOptions.forEach(function (opt) {
                if (!opt.value) return; // skip placeholder
                var text = opt.text; // format: "3.05.01.03.001 - Lemari Besi/Metal"
                var parts = text.split(' - ')[0].split('.');

                if (golVal && parts[0] !== golVal) return;
                if (bidangVal && parts[1] !== bidangVal) return;
                if (kelompokVal && parts[2] !== kelompokVal) return;
                if (subkelVal && parts[3] !== subkelVal) return;

                var option = new Option(opt.text, opt.value);
                barangSelect.add(option);
                count++;
            });

            updateBarangCount(count);
        }

        function updateBarangCount(count) {
            var el = document.getElementById('barangCount');
            if (count === undefined) {
                count = allBarangOptions.filter(o => o.value).length;
                el.textContent = `Menampilkan semua ${count} barang`;
            } else {
                var total = allBarangOptions.filter(o => o.value).length;
                el.textContent = `Menampilkan ${count} dari ${total} barang`;
            }
        }

        // Init
        handleAsalBarang();
        calculateTotal();
    </script>
}
